<template>
  <div class="w-screen h-screen relative keyb">
    <canvas
      @pointerdown="onPointerDown"
      ref="canvas"
      class="w-full h-full absolute"
    ></canvas>
    <input
      v-model="name"
      class="right-2 top-2 absolute bg-yellow-100 z-10"
      @input="onNameChange"
    />
  </div>
</template>

<script setup lang="ts">
import { onUnmounted, ref } from "vue";
import { useCanvasDPI, useAnimationFrames } from "../utils/hooks";
import { vec2 } from "gl-matrix";
import MainAppConfig from "../config/MainAppConfig";
import { GameWasmState } from "game_state/pkg";

const { canvas, size, pixelSize } = useCanvasDPI();
const name = ref("Player");

const gameState = GameWasmState.new();

function myID() {
  return gameState.my_id();
}

const ws = new WebSocket(MainAppConfig.sockerUrl);

ws.onmessage = onmessage;

onUnmounted(() => {
  ws.close();
});

function getMatrix() {
  const worldMatrix = new DOMMatrix();
  worldMatrix.scaleSelf(devicePixelRatio, devicePixelRatio);
  worldMatrix.translateSelf(size.width / 2, size.height / 2);
  return worldMatrix;
}

useAnimationFrames(() => {
  const ctx = canvas.value?.getContext("2d");
  if (!ctx || !canvas.value) return;
  ctx.save();
  ctx.clearRect(0, 0, pixelSize.value.width, pixelSize.value.height);
  ctx.setTransform(getMatrix());
  getPlayers().forEach((player) => {
    const isMe = player.id === myID();
    ctx.fillStyle = isMe ? "#248124" : "black";
    drawPlayer(ctx, player);
  });

  ctx.restore();
});

function drawPlayer(ctx: CanvasRenderingContext2D, player: PlayerState) {
  const SIZE = 10;
  ctx.fillText(
    player.name,
    player.position[0] - SIZE / 2,
    player.position[1] - SIZE
  );
  ctx.fillRect(
    player.position[0] - SIZE / 2,
    player.position[1] - SIZE / 2,
    SIZE,
    SIZE
  );
}

function onNameChange() {
  if (myID) {
    const setPlayerName: SetPlayerName = {
      SetPlayerName: { id: myID() ?? -1, name: name.value },
    };
    ws.send(JSON.stringify(setPlayerName));
  }
}

function onPointerDown(event: PointerEvent) {
  const pointClick = getMatrix()
    .inverse()
    .transformPoint({
      x: event.offsetX * devicePixelRatio,
      y: event.offsetY * devicePixelRatio,
    });
  const me = findMe();

  if (!me) return;

  const deltaX = pointClick.x - me.position[0];
  const deltaY = pointClick.y - me.position[1];
  const p = vec2.fromValues(deltaX, deltaY);
  vec2.normalize(p, p);
  vec2.scale(p, p, 20);
  const newPos = vec2.add(vec2.create(), me.position, p);
  me.position[0] = newPos[0];
  me.position[1] = newPos[1];
  const movePlayer: MovePlayer = {
    MovePlayer: { id: me.id, position: me.position },
  };
  ws.send(JSON.stringify(movePlayer));
}

function onmessage(event: MessageEvent) {
  gameState.on_string_message(event.data);
}

function getPlayers() {
  const players: PlayerState[] = JSON.parse(gameState.get_players());
  return players;
}

function findMe() {
  return getPlayers().find((player) => player.id === myID()) ?? null;
}

interface PlayerState {
  name: string;
  position: [number, number];
  id: number;
}

type BroadCastState = {
  BroadCastState: {
    state: {
      players: PlayerState[];
    };
  };
};

type MovePlayer = {
  MovePlayer: {
    id: number;
    position: [number, number];
  };
};

type PlayerCreatedResponse = {
  PlayerCreatedResponse: {
    id: number;
  };
};

type SetPlayerName = {
  SetPlayerName: {
    id: number;
    name: string;
  };
};

type Messages =
  | BroadCastState
  | MovePlayer
  | PlayerCreatedResponse
  | SetPlayerName;
</script>
